[![Build Status](https://magnum.travis-ci.com/brave/vault.svg?token=tEKWpRH3WZFkPWrgxB9T)](https://magnum.travis-ci.com/brave/vault)

# Brave Vault

A Personal Data Store for holding high-value user behavior with high privacy.


## Setup

Clone the repo: `git clone git@github.com:brave/vault.git`

Install dependencies with `npm install`

Install MongoDB: `brew update && brew install mongodb`

Start MongoDB. There are a variety of ways to do this, one option on a mac: `brew tap homebrew/services && brew services start mongodb`


## Configuration

For staging or production environments configuration variables are stored as environment preferences. See config/config.production.js for a list of these variables.

For local development you can copy config/config.development.js.tpl to config/config.development.js and define the local config variables.


## Running the server

Use `gulp` to run the server in development. This also sets up watchers and will restart the server on a file change.


## Theory of Operation
All operations are available via only HTTPS on public-facing systems.
At a minimum,
all requests are logged with method, path, `Host` and `User-Agent` headers, client IP address,
and `sessionId` parameter (if present);
and all responses are logged with code and diagnostic(if any)
All HTTP content is `application/json`.
Commonly used data types are:

| data type     | syntax                                                                                                      |
| -------------:|:----------------------------------------------------------------------------------------------------------- |
| `adUnitId`    | opaque string                                                                                               |
| `data`        | opaque string  (interpreted only by applications)                                                           |
| `diagnostic`  | localized string intended for logging and human consumption                                                 |
| `replacement` | string containing a (possibly) nested HTML tag                                                              |
| `stats`       | a [statistics summary](#statisticssummary) for the user's behavior                                          |
| `userId`      | [UUID v4](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_.28random.29) string        |
| `tagName`     | string identifing an HTML tag (e.g., `'iframe'` for the `<iframe/>` tag)                                    |
| `timestamp`   | number (usually integer) indicating the number of milli-seconds since the UNIX epoch                        |
| `userId`      | [UUID v4](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_.28random.29) string        |

Errors are "boomlets", e.g.,

        {
          "statusCode": 420,
          "error": "Enhance Your Calm",
          "message": "Your repeated violations of the Verbal Morality Statue ..."
        }

### Users and Sessions
Users are identified with a `userId` that is generated by the browser on initialization.
The user may enter the `userId` into another client in order to consolidate information.
To register a `userId` with the server,
the browser uses the `PUT /v1/users/{userId}` operation.

The result of the operation is one of:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 201  | `sessionId`  | `user` entry created                                     |
| 422  | `boomlet`    | `user entry` already exists                              |

Once a `userId` is successfully registered,
the browser generates (as often as it wishes) a `sessionId` that is used as a parameter for subsequent operations,
in order to identify both the user and browser session.

Optionally,
the browser uses the `DELETE /v1/users/{userId}/sessions/{sessionId}` operation to mark the session as no longer active.
The result of the operation is one of:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 200  | `stats`      | further use of this `sessionId` is not allowed           |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |

On a successful operation,
the corresponding `session` entry is considered "no longer valid".
If a `sessionId` is not referenced in a timely-fashion,
the server may choose to invalidate it.

Regardless of a successful operation or an implicit invalidation,
the `sessionId` may no longer be used to perform new operations.

#### Statistics Summary
A summary of the user's behavior is returned in the `stats` object.
At a minimum,
only one property is returned:

| parameter      | meaning                                                       |
| --------------:|:------------------------------------------------------------- |
| `replacements` | the integer-valued number of advertisements replaced          |

### Recording Intentions
The browser uses the 'POST /v1/users/{userId}/intents' operation to indicate
[user activity](https://github.com/brave/vault/wiki/Intents),
such as clicking on a link.
The parameters are:

| parameter   | meaning                                                          |
| -----------:|:---------------------------------------------------------------- |
| `sessionId` | string, containing a UUID v4 value                               |
| `type`      | e.g., `"browser.site.visit"`                                     |
| `timestamp` | when the user activity started                                   |
| `payload`   | an opaque JSON object                                            |

The result of the operation is:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 200  | `stats`      | intents recorded                                         |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |
| 422  | `boomlet`    | missing parameter                                        |

### Replacing Advertisements
The browser uses the `GET /v1/users/{userId}/ad?...` operation to get information on how to perform a replacement.
The parameters are:

| parameter   | meaning                                                          |
| -----------:|:---------------------------------------------------------------- |
| `sessionId` | string, containing a UUID v4 value                               |
| `tagName`   | at present, 'iframe' (for the `<iframe/>` tag)                   |
| `width`     | the width in pixels of the replacement advertisement             |
| `height`    | the height in pixels of the replacement advertisement            |

The result of the operation is:

| code | payload      | meaning                                                  |
| ----:|:------------:|:-------------------------------------------------------- |
| 301  |              | a data URL acting as a replacement for the advertisement |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |
| 422  | `boomlet`    | missing parameter                                        |

The `replacement` parameter has the form:

        data:text/html;charset=utf-8,<html>...<a href='https:.../v1/ad-clicks/{adUnitId}'><img src='...' /></a>...</html>

If the user clicks on this `<a/>` tag,
then in addition to (automatically) using the `POST /v1/users/{userId}/intents` operation to record the 'click',
the brower also uses the `GET /v1/ad-clicks/{adUnitId}` operation.
The result of the operation is:

| code | payload      | meaning                                                              |
| ----:|:------------:|:-------------------------------------------------------------------- |
| 301  |              | `Location` header redirects to advertiser's site                     |
| 404  |              | `adUnitId` does not refer to an existing replacement advertisement   |

### Synchronizing Applications
Applications use an _advisory locking_ scheme in order to synchronize and persist shared information.

The browser uses the `GET /v1/users/{userId}/appState` operation to retrieve information shared between all applications for
the corresponding user.
The result of the operation is one of:

| code | payload       | meaning                                                 |
| ----:|:------------:|:-------------------------------------------------------- |
| 200  | `timestamp`   | the current timestamp of the stored state               |
|      | `payload`     | an opaque JSON object                                   |
| 404  | `boomlet`    | `userId` does not refer to an existing user              |

The `payload` object is opaque to the server -- the applications are responsible for determining the syntax and semantics
of the information.
If no information has been previously stored for the corresponding `userId`,
the empty object (`{}`) is returned.

The browser uses the `PUT /v1/users/{userId}/appState` operation to update information shared between all applications for
the corresponding user.
The parameters are:

| parameter   | meaning                                                          |
| -----------:|:---------------------------------------------------------------- |
| `timestamp`  | the timestamp associated with the `payload`                     |
| `payload`    | an opaque JSON object                                           |

The result of the operation is one of:

| code | payload       | meaning                                                                |
| ----:|:------------:|:----------------------------------------------------------------------- |
| 200  | `timestamp`   | the current timestamp of the `payload` stored                          |
| 404  | `boomlet`     | `userId` does not refer to an existing user                             |
| 422  | `boomlet`     | `timestamp` parameter does not match the timestamp of the stored state |

Accordingly,
to successfully update the shared information,
the browser must:

1. use the `GET /v1/users/{userId}/appState` operation to retrieve the current information; then,
2. modify the returned `payload` as appropriate; then,
3. use the `PUT /v1/users/{userId}/appState`' operation with the previously-returned `timestamp` and the modified `payload`
4. if a `422` is returned, go back to Step 1; otherwise,
5. optionally: locally persist the newly-returned returned `timestamp`and the modified `payload`,
so as to skip Step 1 the next time a state update is desired.

This allows multiple applications to (patiently) coordinate their actions in upading the shared information.
However,
if an application *must* unilaterally overwrite the shared information,
it omits the `timestamp` parameter to the `PUT /v1/users/{userId}/appState` operation.

### Management operations
**Q: `/ad-manifest` ?**

## Practice of Operation
**TBD.**

### Database usage

### Bitcoin wallet provisioning

### Advertisement provisioning

cf., https://github.com/brave/vault/wiki/Content-Categories
https://docs.google.com/document/d/10_dluieRIRQpRc9sBMOuV-27rzQxLHm1_5Y-RztAx0w
